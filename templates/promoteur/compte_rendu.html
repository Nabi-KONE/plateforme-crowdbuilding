{% extends 'promoteur/base_promoteur.html' %}
{% load static %}

{% block title %}Soumettre un Compte Rendu - Promoteur{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">Soumettre un compte rendu</h1>
                    <p class="text-muted mb-0">
                        {% if projet_initial %}
                            Projet : {{ projet_initial.titre }}
                        {% else %}
                            Sélectionnez un projet
                        {% endif %}
                    </p>
                    <p class="text-info small mb-0">
                        <i class="ri-information-line"></i> 
                        Le compte rendu sera soumis à validation administrative
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Afficher les messages d'erreur -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'danger' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <!-- Afficher les erreurs globales du formulaire -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger mb-4">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <form method="post" enctype="multipart/form-data" id="compteRenduForm">
                        {% csrf_token %}
                        
                        <!-- Champ caché pour images (formset Django) -->
                        {{ image_formset.management_form }}
                        
                        <!-- Informations du compte rendu -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="ri-file-text-line me-2"></i>Informations du compte rendu
                            </h5>
                            
                            <!-- Projet (pré-sélectionné si venant d'un projet spécifique) -->
                            <div class="mb-4">
                                {% if projet_initial %}
                                    <!-- Mode projet pré-sélectionné -->
                                    <div class="alert alert-info mb-3">
                                        <i class="ri-information-line me-2"></i>
                                        Compte rendu pour le projet : <strong>{{ projet_initial.titre }}</strong>
                                    </div>
                                    <!-- CHAMP DJANGO POUR PROJET (HIDDEN) -->
                                    <input type="hidden" name="projet" value="{{ projet_initial.id }}" id="id_projet">
                                    
                                    <!-- Afficher les informations du projet -->
                                    <div class="card border-info mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ projet_initial.titre }}</h6>
                                            <p class="card-text small text-muted mb-1">
                                                Référence : {{ projet_initial.reference }}
                                            </p>
                                            <p class="card-text small text-muted mb-1">
                                                Statut : {{ projet_initial.get_statut_display }}
                                            </p>
                                            <p class="card-text small text-muted mb-0">
                                                Avancement actuel : {{ projet_initial.taux_financement|floatformat:1 }}%
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-text">
                                        <i class="ri-information-line"></i> 
                                        Vous créez un compte rendu spécifique pour ce projet.
                                        <a href="{% url 'projects:promoteur_compte_rendu' %}" class="ms-2">
                                            <i class="ri-arrow-go-back-line"></i> Créer pour un autre projet
                                        </a>
                                    </div>
                                {% else %}
                                    <!-- Mode sélection libre - UTILISER LE CHAMP DJANGO -->
                                    <label class="form-label fw-semibold">{{ form.projet.label }}</label>
                                    {{ form.projet }}
                                    {% if form.projet.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.projet.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if form.projet.help_text %}
                                        <div class="form-text">{{ form.projet.help_text }}</div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <!-- Étape concernée - UTILISER LE CHAMP DJANGO -->
                            <div class="mb-4" id="etapeSection" style="display: none;">
                                <label class="form-label fw-semibold">{{ form.etape.label }}</label>
                                {{ form.etape }}
                                {% if form.etape.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.etape.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="ri-information-line"></i> 
                                    Relier le compte rendu à une étape facilite le suivi pour les investisseurs
                                </div>
                            </div>
                            
                            <!-- Titre - UTILISER LE CHAMP DJANGO -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">{{ form.titre.label }}</label>
                                {{ form.titre }}
                                {% if form.titre.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.titre.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Contenu détaillé - UTILISER LE CHAMP DJANGO -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">{{ form.contenu.label }}</label>
                                {{ form.contenu }}
                                <div class="form-text text-end">
                                    <span id="compteur-caracteres">0</span> caractères
                                </div>
                                {% if form.contenu.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.contenu.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if form.contenu.help_text %}
                                    <div class="form-text">{{ form.contenu.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Pourcentage d'avancement -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="ri-progress-3-line me-2"></i>Avancement global du projet *
                            </label>
                            
                            <div class="alert alert-light mb-3">
                                <div class="d-flex">
                                    <i class="ri-information-line me-3 text-primary"></i>
                                    <div>
                                        <small>
                                            Indiquez l'avancement global du projet depuis le dernier compte rendu.
                                            <strong>Cette information sera vérifiée par l'administration.</strong>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- IMPORTANT: CHAMP CACHÉ POUR STOCKER LA VALEUR -->
                            <input type="hidden" name="avancement" id="id_avancement" value="0">
                            
                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Range input pour l'affichage visuel -->
                                    <input type="range" class="form-range" min="0" max="100" step="5" 
                                        value="0" id="avancementRange" 
                                        style="width: 100%;">
                                    
                                    <!-- Affichage de la valeur -->
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="badge bg-secondary">0%</span>
                                        <span class="badge bg-secondary">25%</span>
                                        <span class="badge bg-secondary">50%</span>
                                        <span class="badge bg-secondary">75%</span>
                                        <span class="badge bg-secondary">100%</span>
                                    </div>
                                    
                                    <!-- Valeur actuelle -->
                                    <div class="text-center mt-3">
                                        <span class="fs-4 fw-bold" id="avancementValueDisplay">0%</span>
                                        <div class="small text-muted">Avancement sélectionné</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-0 bg-light h-100">
                                        <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                            <div class="display-4 mb-2 text-primary" id="avancementCircle">0%</div>
                                            <small class="text-muted text-center">Progression globale du projet</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Suggestions d'avancement -->
                            <div class="mt-3">
                                <small class="text-muted d-block mb-2">
                                    <i class="ri-lightbulb-line"></i> Suggestions rapides :
                                </small>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setAvancement(25)">25% - Début</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setAvancement(50)">50% - Mi-parcours</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setAvancement(75)">75% - Avancé</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setAvancement(90)">90% - Presque fini</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setAvancement(100)">100% - Terminé</button>
                                </div>
                            </div>
                            
                            <!-- Afficher les erreurs du champ avancement Django -->
                            {% if form.avancement.errors %}
                                <div class="text-danger small mt-2">
                                    {% for error in form.avancement.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <!-- Documentation visuelle - VERSION SIMPLIFIÉE -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="ri-image-line me-2"></i>Documentation visuelle
                            </h5>
                            
                            <div class="alert alert-warning mb-3">
                                <div class="d-flex">
                                    <i class="ri-alert-line me-3"></i>
                                    <div>
                                        <strong>Validation administrative :</strong> 
                                        Les images permettent de vérifier l'avancement réel du projet.
                                        <br>
                                        <small>Les comptes rendus sans documentation visuelle peuvent prendre plus de temps à valider.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <label class="form-label fw-semibold">Images d'avancement *</label>
                            
                            <!-- Zone de dépôt d'images - SIMPLIFIÉE -->
                            <div class="border-2 border-dashed rounded p-5 text-center mb-3 drop-zone" 
                                id="dropZone">
                                <i class="ri-image-add-line text-muted fs-1 mb-3 d-block"></i>
                                <h6 class="text-muted mb-2">Cliquez ou glissez-déposez des images</h6>
                                <p class="text-muted small mb-3">Formats acceptés : JPG, PNG, WebP</p>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('imageUpload').click()">
                                    <i class="ri-folder-open-line me-1"></i>Parcourir les fichiers
                                </button>
                                <input type="file" class="d-none" name="image_uploads" multiple 
                                       accept="image/jpeg,image/png,image/webp" id="imageUpload">
                            </div>
                            
                            <!-- Règles d'upload -->
                            <div class="alert alert-light small mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <i class="ri-check-line text-success me-1"></i>
                                        <strong>Minimum :</strong> 1 image
                                    </div>
                                    <div class="col-md-6">
                                        <i class="ri-check-line text-success me-1"></i>
                                        <strong>Maximum :</strong> 5 images
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Aperçu des images -->
                            <div id="imagePreview" class="row g-2 mb-3"></div>
                            
                            <!-- Compteur d'images -->
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-text">
                                    <span id="imageCount">0</span> image(s) sélectionnée(s)
                                </div>
                                <div>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllImages()">
                                        <i class="ri-delete-bin-line me-1"></i>Tout supprimer
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Champ caché pour le formset -->
                            {% for form_img in image_formset %}
                                {% if forloop.first %}
                                    <!-- Premier formulaire visible -->
                                    <div class="image-form" id="image-form-0">
                                        {{ form_img.image }}
                                        {{ form_img.legende }}
                                        {{ form_img.DELETE }}
                                        {% if form_img.id %}{{ form_img.id }}{% endif %}
                                    </div>
                                {% else %}
                                    <!-- Autres formulaires cachés -->
                                    <div class="image-form d-none" id="image-form-{{ forloop.counter0 }}">
                                        {{ form_img.image }}
                                        {{ form_img.legende }}
                                        {{ form_img.DELETE }}
                                        {% if form_img.id %}{{ form_img.id }}{% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <!-- Validation administrative (information seulement) -->
                        <div class="alert alert-info mb-4">
                            <div class="d-flex">
                                <i class="ri-shield-check-line me-3 fs-4"></i>
                                <div>
                                    <h6 class="alert-heading mb-2">Processus de validation administrative</h6>
                                    <ol class="mb-0 small">
                                        <li>Vous soumettez ce compte rendu</li>
                                        <li>L'administration examine les informations et images fournies</li>
                                        <li>Le compte rendu est <strong class="text-success">validé</strong> ou <strong class="text-danger">rejeté</strong> avec motif</li>
                                        <li>Une fois validé, le compte rendu est visible par les investisseurs</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex gap-3 justify-content-between border-top pt-4">
                            <a href="{% url 'projects:promoteur_projets' %}" class="btn btn-outline-secondary">
                                <i class="ri-arrow-left-line me-2"></i>Retour aux projets
                            </a>
                            <div>
                                <button type="button" class="btn btn-outline-info me-2" onclick="previewCompteRendu()">
                                    <i class="ri-eye-line me-2"></i>Aperçu
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="ri-send-plane-line me-2"></i>Soumettre pour validation
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'aperçu -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Aperçu du compte rendu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Contenu généré dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('compteRenduForm').submit()">
                    <i class="ri-send-plane-line me-2"></i>Confirmer la soumission
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variable globale pour les images uploadées
let uploadedImages = [];

document.addEventListener('DOMContentLoaded', function() {
    // ============================================
    // 1. COMPTEUR DE CARACTÈRES - FONCTIONNEL
    // ============================================
    const textarea = document.getElementById('id_contenu');
    const compteur = document.getElementById('compteur-caracteres');

    if (textarea && compteur) {
        const updateCompteur = () => {
            const length = textarea.value.length;
            compteur.textContent = length + ' caractères';
            
            if (length < 200) {
                compteur.className = 'text-danger';
            } else if (length < 500) {
                compteur.className = 'text-warning';
            } else {
                compteur.className = 'text-success';
            }
        };
        
        updateCompteur();
        textarea.addEventListener('input', updateCompteur);
    }
    
    // ============================================
    // 2. GESTION DE L'AVANCEMENT - FONCTIONNEL
    // ============================================
    const avancementRange = document.getElementById('avancementRange');
    const avancementValueDisplay = document.getElementById('avancementValueDisplay');
    const avancementHidden = document.getElementById('id_avancement');
    const avancementCircle = document.getElementById('avancementCircle');
    
    if (avancementRange && avancementValueDisplay && avancementHidden) {
        const updateAvancement = (value) => {
            avancementValueDisplay.textContent = value + '%';
            avancementHidden.value = value;
            
            if (avancementCircle) {
                avancementCircle.textContent = value + '%';
                if (value < 25) {
                    avancementCircle.className = 'display-4 mb-2 text-danger';
                } else if (value < 50) {
                    avancementCircle.className = 'display-4 mb-2 text-warning';
                } else if (value < 75) {
                    avancementCircle.className = 'display-4 mb-2 text-info';
                } else {
                    avancementCircle.className = 'display-4 mb-2 text-success';
                }
            }
        };
        
        avancementRange.addEventListener('input', function() {
            updateAvancement(this.value);
        });
        
        updateAvancement(avancementRange.value);
    }
    
    // Fonction pour définir l'avancement rapidement
    window.setAvancement = function(value) {
        const avancementRange = document.getElementById('avancementRange');
        const avancementHidden = document.getElementById('id_avancement');
        
        if (avancementRange && avancementHidden) {
            avancementRange.value = value;
            avancementHidden.value = value;
            avancementRange.dispatchEvent(new Event('input'));
        }
    };
    
    // ============================================
    // 3. GESTION DU PROJET POUR AFFICHER LES ÉTAPES
    // ============================================
    const selectProjet = document.getElementById('id_projet');
    const etapeSection = document.getElementById('etapeSection');
    const selectEtape = document.getElementById('id_etape');
    
    if (selectProjet) {
        selectProjet.addEventListener('change', function() {
            const projetId = this.value;
            
            if (projetId) {
                if (etapeSection) etapeSection.style.display = 'block';
                chargerEtapesProjet(projetId);
            } else {
                if (etapeSection) etapeSection.style.display = 'none';
                if (selectEtape) selectEtape.innerHTML = '<option value="">Sélectionnez une étape (optionnel)</option>';
            }
        });
    }
    
    function chargerEtapesProjet(projetId) {
        if (!selectEtape) return;
        
        selectEtape.innerHTML = '<option value="">Chargement des étapes...</option>';
        
        fetch(`/projects/ajax/get-etapes-projet/?projet_id=${projetId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    selectEtape.innerHTML = '<option value="">Sélectionnez une étape (optionnel)</option>';
                    data.etapes.forEach(etape => {
                        const option = document.createElement('option');
                        option.value = etape.id;
                        option.textContent = etape.texte;
                        selectEtape.appendChild(option);
                    });
                } else {
                    selectEtape.innerHTML = '<option value="">Aucune étape disponible</option>';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                selectEtape.innerHTML = '<option value="">Erreur de chargement</option>';
            });
    }
    
    // ============================================
    // 4. GESTION DES IMAGES - CORRIGÉ
    // ============================================
    const imageUpload = document.getElementById('imageUpload');
    const imagePreview = document.getElementById('imagePreview');
    const dropZone = document.getElementById('dropZone');
    const imageCount = document.getElementById('imageCount');
    
    // Click sur la zone de dépôt
    if (dropZone) {
        dropZone.addEventListener('click', function() {
            if (imageUpload) imageUpload.click();
        });
        
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('border-primary', 'bg-light');
        });
        
        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('border-primary', 'bg-light');
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('border-primary', 'bg-light');
            if (imageUpload && e.dataTransfer.files.length > 0) {
                imageUpload.files = e.dataTransfer.files;
                handleImageUpload();
            }
        });
    }
    
    // Changement de fichier
    if (imageUpload) {
        imageUpload.addEventListener('change', handleImageUpload);
    }
    
    function handleImageUpload() {
        if (!imageUpload || !imageUpload.files) return;
        
        const files = Array.from(imageUpload.files);
        
        // Vérifier le nombre maximum d'images
        if (uploadedImages.length + files.length > 5) {
            alert('Maximum 5 images autorisées. Vous avez déjà ' + uploadedImages.length + ' image(s).');
            return;
        }
        
        for (let file of files) {
            if (file.size > 10 * 1024 * 1024) {
                alert(`L'image "${file.name}" dépasse la taille maximale de 10MB.`);
                continue;
            }
            
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
            if (!allowedTypes.includes(file.type)) {
                alert(`Le fichier "${file.name}" n'est pas une image valide.`);
                continue;
            }
            
            uploadedImages.push(file);
        }
        
        updateImagePreview();
        updateImageCount();
        updateFormsetInputs();
    }
    
    function updateImagePreview() {
        if (!imagePreview) return;
        
        imagePreview.innerHTML = '';
        
        uploadedImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-3 mb-3';
                col.innerHTML = `
                    <div class="card border-0 shadow-sm h-100">
                        <div class="position-relative">
                            <img src="${e.target.result}" class="card-img-top" style="height: 120px; object-fit: cover; width: 100%;">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                    onclick="removeImage(${index})" style="z-index: 10;">
                                <i class="ri-close-line"></i>
                            </button>
                        </div>
                        <div class="card-body p-2">
                            <small class="text-muted d-block text-truncate" title="${file.name}">${file.name}</small>
                            <small class="text-muted">${formatFileSize(file.size)}</small>
                        </div>
                    </div>
                `;
                imagePreview.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Fonction pour supprimer une image
    window.removeImage = function(index) {
        if (confirm('Supprimer cette image ?')) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
            updateImageCount();
            updateFormsetInputs();
            
            // Mettre à jour l'input file
            const dataTransfer = new DataTransfer();
            uploadedImages.forEach(file => dataTransfer.items.add(file));
            if (imageUpload) imageUpload.files = dataTransfer.files;
        }
    };
    
    // Fonction pour tout supprimer
    window.clearAllImages = function() {
        if (uploadedImages.length > 0 && confirm('Supprimer toutes les images ?')) {
            uploadedImages = [];
            if (imageUpload) imageUpload.value = '';
            updateImagePreview();
            updateImageCount();
            updateFormsetInputs();
        }
    };
    
    function updateImageCount() {
        if (imageCount) {
            imageCount.textContent = uploadedImages.length;
            if (uploadedImages.length === 0) {
                imageCount.className = 'text-danger';
            } else if (uploadedImages.length < 3) {
                imageCount.className = 'text-warning';
            } else {
                imageCount.className = 'text-success';
            }
        }
    }
    
    // Mettre à jour les inputs du formset Django
    function updateFormsetInputs() {
        // Pour chaque image, créer ou mettre à jour un champ dans le formset
        uploadedImages.forEach((file, index) => {
            // Trouver ou créer le formulaire correspondant
            let formDiv = document.getElementById(`image-form-${index}`);
            if (!formDiv) {
                // S'il n'existe pas, on peut en créer un nouveau
                // Mais pour simplifier, on va utiliser les champs cachés
                return;
            }
            
            // Créer un DataTransfer pour le fichier
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            
            // Trouver l'input file dans le formset
            const fileInput = formDiv.querySelector('input[type="file"]');
            if (fileInput) {
                fileInput.files = dataTransfer.files;
            }
        });
    }
    
    // ============================================
    // 5. FONCTION D'APERÇU - CORRIGÉE
    // ============================================
    window.previewCompteRendu = function() {
        // Récupérer les valeurs des champs
        const selectProjet = document.getElementById('id_projet');
        const titreInput = document.getElementById('id_titre');
        const avancementInput = document.getElementById('id_avancement');
        const contenuTextarea = document.getElementById('id_contenu');
        const selectEtape = document.getElementById('id_etape');
        
        let projetText = '';
        let titre = '';
        let avancement = '0';
        let etapeText = '';
        
        if (selectProjet) {
            if (selectProjet.tagName === 'SELECT') {
                const selectedOption = selectProjet.options[selectProjet.selectedIndex];
                projetText = selectedOption ? selectedOption.text : '';
            } else if (selectProjet.tagName === 'INPUT') {
                projetText = 'Projet sélectionné';
            }
        }
        
        if (titreInput) {
            titre = titreInput.value.trim();
        }
        
        if (avancementInput) {
            avancement = avancementInput.value || '0';
        }
        
        if (selectEtape) {
            const selectedEtape = selectEtape.options[selectEtape.selectedIndex];
            etapeText = selectedEtape ? selectedEtape.text : '';
        }
        
        const contenu = contenuTextarea ? contenuTextarea.value.trim() : '';
        
        // Générer l'aperçu HTML
        let previewHTML = `
            <div class="preview-container">
                <h5 class="mb-3 text-primary">${titre || '<span class="text-muted">[Titre non défini]</span>'}</h5>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Projet :</strong> ${projetText || '<span class="text-muted">[Non sélectionné]</span>'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Avancement :</strong> <span class="badge bg-${avancement < 25 ? 'danger' : avancement < 50 ? 'warning' : avancement < 75 ? 'info' : 'success'}">${avancement}%</span></p>
                    </div>
                </div>
        `;
        
        if (etapeText && etapeText !== 'Sélectionnez une étape (optionnel)' && 
            etapeText !== 'Chargement des étapes...' && 
            etapeText !== 'Aucune étape disponible' && 
            etapeText !== 'Erreur de chargement' && 
            etapeText !== '') {
            previewHTML += `<p><strong>Étape concernée :</strong> ${etapeText}</p>`;
        }
        
        previewHTML += `
                <hr>
                
                <h6>Contenu détaillé :</h6>
                <div class="border rounded p-3 bg-light mb-3" style="max-height: 300px; overflow-y: auto;">
                    ${contenu.replace(/\n/g, '<br>') || '<span class="text-muted">[Contenu vide]</span>'}
                </div>
                
                <p class="text-muted small">Longueur : ${contenu.length} caractères (minimum requis: 200)</p>
                
                <hr>
                
                <h6>Images (${uploadedImages.length}) :</h6>
        `;
        
        if (uploadedImages.length > 0) {
            previewHTML += '<div class="row g-2">';
            uploadedImages.forEach((file, index) => {
                previewHTML += `
                    <div class="col-3 mb-2">
                        <div class="border rounded p-2 text-center">
                            <i class="ri-image-line fs-3 text-muted mb-1"></i>
                            <small class="d-block text-truncate" title="${file.name}">${file.name}</small>
                            <small class="text-muted">${formatFileSize(file.size)}</small>
                        </div>
                    </div>
                `;
            });
            previewHTML += '</div>';
        } else {
            previewHTML += '<p class="text-warning"><i class="ri-alert-line"></i> Aucune image fournie</p>';
        }
        
        previewHTML += `
                <hr>
                <div class="alert alert-info">
                    <i class="ri-information-line"></i>
                    <strong>Note :</strong> Ce compte rendu sera soumis pour validation administrative.
                    Il devra être approuvé par l'équipe avant d'être visible par les investisseurs.
                </div>
            </div>
        `;
        
        const previewContent = document.getElementById('previewContent');
        if (previewContent) {
            previewContent.innerHTML = previewHTML;
        }
        
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        previewModal.show();
    };
    
    // ============================================
    // 6. VALIDATION DU FORMULAIRE
    // ============================================
    const form = document.getElementById('compteRenduForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Validation manuelle
            const titre = document.getElementById('id_titre')?.value.trim();
            const contenu = document.getElementById('id_contenu')?.value.trim();
            const avancement = document.getElementById('id_avancement')?.value;
            
            let errors = [];
            
            if (!titre) errors.push("Le titre est requis");
            if (!contenu || contenu.length < 200) errors.push("Le contenu doit contenir au moins 200 caractères");
            if (!avancement || avancement === '0') errors.push("Veuillez spécifier un pourcentage d'avancement");
            if (uploadedImages.length === 0) errors.push("Au moins une image est requise");
            
            if (errors.length > 0) {
                e.preventDefault();
                alert('Veuillez corriger les erreurs suivantes :\n\n- ' + errors.join('\n- '));
                return false;
            }
            
            // Si tout est bon, soumettre
            return true;
        });
    }
    
    // Déclencher l'événement change du projet si pré-sélectionné
    {% if projet_initial %}
    if (selectProjet) {
        selectProjet.dispatchEvent(new Event('change'));
    }
    {% endif %}
});
</script>

<style>
.drop-zone {
    border-color: #dee2e6;
    border-style: dashed;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.drop-zone:hover {
    background: #e9ecef;
    border-color: #0d6efd;
}

#avancementCircle {
    transition: all 0.3s ease;
}

.form-range::-webkit-slider-thumb {
    background: #0d6efd;
    width: 20px;
    height: 20px;
}

.form-range::-moz-range-thumb {
    background: #0d6efd;
    width: 20px;
    height: 20px;
    border: none;
}

#imagePreview img {
    transition: transform 0.3s ease;
}

#imagePreview img:hover {
    transform: scale(1.05);
}

/* Styles pour les champs Django */
.form-select, .form-control {
    border: 1px solid #dee2e6;
}

.form-select:focus, .form-control:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.image-form {
    display: none; /* Cacher les champs du formset */
}
</style>
{% endblock %}