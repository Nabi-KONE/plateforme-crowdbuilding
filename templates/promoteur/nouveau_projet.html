<!-- promoteur/nouveau_projet.html -->
{% extends 'promoteur/base_promoteur.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Nouveau Projet - Étape 1/2{% endblock %}
{% block page_title %}Nouveau projet{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Indicateur de progression -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="steps-progress">
                <div class="step active">
                    <span class="step-number">1</span>
                    <span class="step-label">Informations du projet</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span class="step-label">Étapes (optionnel)</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span class="step-label">Confirmation</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="ri-building-line me-2"></i>Création d'un nouveau projet
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="projetForm">
                        {% csrf_token %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Veuillez corriger les erreurs ci-dessous :</strong>
                            {{ form.errors }}
                        </div>
                        {% endif %}

                        <!-- Section 1: Informations générales -->
                        <div class="section-header mb-3">
                            <h6 class="fw-bold text-primary">
                                <i class="ri-information-line me-2"></i>1. Informations générales
                            </h6>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.titre.id_for_label }}" class="form-label required">
                                        {{ form.titre.label }}
                                    </label>
                                    {{ form.titre }}
                                    <small class="form-text text-muted">{{ form.titre.help_text }}</small>
                                    {% if form.titre.errors %}
                                    <div class="invalid-feedback d-block">{{ form.titre.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.categorie.id_for_label }}" class="form-label required">
                                        {{ form.categorie.label }}
                                    </label>
                                    {{ form.categorie }}
                                    <small class="form-text text-muted">{{ form.categorie.help_text }}</small>
                                    {% if form.categorie.errors %}
                                    <div class="invalid-feedback d-block">{{ form.categorie.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="{{ form.description.id_for_label }}" class="form-label required">
                                        {{ form.description.label }}
                                    </label>
                                    {{ form.description }}
                                    <div class="form-text">
                                        <span id="charCount">0</span> / 100 caractères minimum
                                    </div>

                                    {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Finances -->
                        <div class="section-header mb-3">
                            <h6 class="fw-bold text-primary">
                                <i class="ri-money-euro-circle-line me-2"></i>2. Finances
                            </h6>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_montant_total" class="form-label required">
                                        Coût total de réalisation (FCFA) *
                                    </label>
                                    <div class="input-group">
                                       {{ form.montant_total }}
                                        <span class="input-group-text">FCFA</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_nombre_total_parts" class="form-label required">
                                        Nombre total de parts *
                                    </label>
                                    {{ form.nombre_total_parts }}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_nombre_min_parts" class="form-label required">
                                        Nombre minimum de parts par investisseur *
                                    </label>
                                    {{ form.nombre_min_parts }}
                                    {% if form.nombre_min_parts.errors %}
                                    <div class="invalid-feedback d-block">{{ form.nombre_min_parts.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Section prix unitaire -->
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.prix_unitaire_affiche.id_for_label }}" class="form-label">
                                        {{ form.prix_unitaire_affiche.label }}
                                    </label>
                                    {{ form.prix_unitaire_affiche }}
                                    <small class="form-text text-muted">{{ form.prix_unitaire_affiche.help_text }}</small>
                                    
                                    <!-- Champ caché pour le prix unitaire réel -->
                                    <input type="hidden" 
                                        name="prix_unitaire" 
                                        id="id_prix_unitaire_hidden"
                                        value="{{ form.instance.prix_unitaire|default:'' }}">
                                    
                                    <div class="mt-1">
                                        <small class="text-danger" id="prix_unitaire_error" style="display: none;">
                                            Le prix unitaire doit être d'au moins 100 FCFA
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Calendrier -->
                        <div class="section-header mb-3">
                            <h6 class="fw-bold text-primary">
                                <i class="ri-calendar-line me-2"></i>3. Calendrier
                            </h6>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="id_duree_campagne" class="form-label required">
                                        Durée de collecte (mois) *
                                    </label>
                                  {{ form.duree_campagne }}
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="id_date_debut" class="form-label required">
                                        Date de début de réalisation prévue*
                                    </label>
                                    {{ form.date_debut }}
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="id_duree" class="form-label required">
                                        Durée de réalisation prévue (mois) *
                                    </label>
                                   {{ form.duree }}
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Date de fin prévue </label>
                                    <div class="input-group">
                                        <input type="text" 
                                            class="form-control" 
                                            id="date_fin_calculee" 
                                            readonly
                                            placeholder="Calculée automatiquement">
                                        <span class="input-group-text">
                                            <i class="ri-calendar-line"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 4: Localisation -->
                        <div class="section-header mb-3">
                            <h6 class="fw-bold text-primary">
                                <i class="ri-map-pin-line me-2"></i>4. Localisation
                            </h6>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.localisation.id_for_label }}" class="form-label required">
                                        {{ form.localisation.label }}
                                    </label>
                                    {{ form.localisation }}
                                    <small class="form-text text-muted">Lieu du projet</small>
                                    {% if form.localisation.errors %}
                                    <div class="invalid-feedback d-block">{{ form.localisation.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.ville.id_for_label }}" class="form-label required">
                                        {{ form.ville.label }}
                                    </label>
                                    {{ form.ville }}
                                    {% if form.ville.errors %}
                                    <div class="invalid-feedback d-block">{{ form.ville.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.region.id_for_label }}" class="form-label required">
                                        {{ form.region.label }}
                                    </label>
                                    {{ form.region }}
                                    {% if form.region.errors %}
                                    <div class="invalid-feedback d-block">{{ form.region.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: Documents obligatoires -->
                        <div class="section-header mb-3">
                            <h6 class="fw-bold text-primary">
                                <i class="ri-file-text-line me-2"></i>5. Documents
                            </h6>
                        </div>
                        
                        <div class="alert alert-warning mb-3">
                            <i class="ri-alert-line me-2"></i>
                            Ces documents sont obligatoires pour la soumission
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_document_foncier" class="form-label required">
                                        Document foncier *
                                    </label>
                                    {{ form.document_foncier }}
                                    <small class="form-text text-muted">Titre de propriété</small>
                                    {% if form.document_foncier.errors %}
                                    <div class="invalid-feedback d-block">{{ form.document_foncier.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_document_technique" class="form-label required">
                                        Permis de construire *
                                    </label>
                                    {{ form.document_technique }}
                                    <small class="form-text text-muted">Document technique</small>
                                    {% if form.document_technique.errors %}
                                    <div class="invalid-feedback d-block">{{ form.document_technique.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="id_document_financier" class="form-label required">
                                        Budget global *
                                    </label>
                                    {{ form.document_financier }}
                                    <small class="form-text text-muted">Document financier</small>
                                    {% if form.document_financier.errors %}
                                    <div class="invalid-feedback d-block">{{ form.document_financier.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section 6: Image de garde -->
                        <div class="section-header mb-3">
                            <h6 class="fw-bold text-primary">
                                <i class="ri-image-line me-2"></i>6. Image de garde
                            </h6>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.image_garde.id_for_label }}" class="form-label required">
                                        {{ form.image_garde.label }}
                                    </label>
                                    {{ form.image_garde }}
                                    <small class="form-text text-muted">{{ form.image_garde.help_text }}</small>
                                    {% if form.image_garde.errors %}
                                    <div class="invalid-feedback d-block">{{ form.image_garde.errors }}</div>
                                    {% endif %}
                                    
                                    <div class="mt-3" id="imagePreview" style="display: none;">
                                        <img id="previewImage" class="img-thumbnail" style="max-height: 150px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 7 : Options des étapes -->
                        <div class="section-header mb-3">
                            <h6 class="fw-bold text-primary">
                                <i class="ri-list-check-2 me-2"></i>7. Étape suivante
                            </h6>
                        </div>
                        
                        <div class="alert alert-light mb-4">
                            <div class="form-check">
                                {{ form.definir_etapes_maintenant }}
                                <label for="{{ form.definir_etapes_maintenant.id_for_label }}" class="form-check-label">
                                    Définir les étapes maintenant (optionnel)
                                </label>
                                <small class="form-text text-muted d-block mt-1">
                                    Si coché : Vous serez redirigé vers la définition des étapes<br>
                                    Si non coché : Vous serez redirigé directement vers la confirmation
                                </small>
                            </div>
                        </div>

                        <!-- Information sur le seuil de déclenchement -->
                        <div class="alert alert-info mt-4">
                            <div class="d-flex align-items-center">
                                <i class="ri-information-line me-3 fs-4"></i>
                                <div>
                                    <h6 class="alert-heading mb-2">Informations importantes</h6>
                                    <ul class="mb-0">
                                        <li><strong>Seuil de déclenchement :</strong> Le projet démarre uniquement si <strong class="text-success">100%</strong> du montant est collecté</li>
                                        <li><strong>Prix unitaire :</strong> Calculé automatiquement (Coût total ÷ Nombre de parts)</li>
                                        <li><strong>Dates :</strong> Les dates de fin sont calculées automatiquement</li>
                                        <li><strong>Validation :</strong> Le projet sera examiné par l'administration avant publication</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between border-top pt-4">
                            <a href="{% url 'projects:promoteur_projets' %}" class="btn btn-outline-secondary">
                                <i class="ri-arrow-left-line me-2"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="ri-arrow-right-line me-2"></i>Continuer vers l'étape suivante
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    const montantTotal = document.getElementById('id_montant_total');
    const nombreParts = document.getElementById('id_nombre_total_parts');
    const nombreMinParts = document.getElementById('id_nombre_min_parts');
    const prixAffiche = document.getElementById('id_prix_unitaire_affiche');
    const prixHidden = document.getElementById('id_prix_unitaire_hidden');

    const dateDebut = document.getElementById('id_date_debut');
    const duree = document.getElementById('id_duree');
    const dateFin = document.getElementById('date_fin_calculee');

    const description = document.getElementById('id_description');
    const charCount = document.getElementById('charCount');
    const MIN_CHARS = 100;

    /* =======================
       PRIX UNITAIRE
    ======================= */
    function calculerPrixUnitaire() {
        if (!montantTotal || !nombreParts) return;

        const total = parseFloat(montantTotal.value);
        const parts = parseInt(nombreParts.value);

        if (!total || !parts || parts === 0) {
            prixAffiche.value = 'Calculé automatiquement';
            prixHidden.value = '';
            return;
        }

        const prix = Math.round(total / parts);
        prixAffiche.value = prix.toLocaleString('fr-FR') + ' FCFA';
        prixHidden.value = prix;
    }

    /* =======================
       Minimu de de parts
    ======================= */
    function verifierNombreMin() {
        const total = parseInt(nombreParts.value) || 0;
        let min = parseInt(nombreMinParts.value) || 1;

        if (min > total) {
            min = total; // impossible que le minimum dépasse le total
            nombreMinParts.value = min;
        }
    }

    if (nombreParts && nombreMinParts) {
        nombreParts.addEventListener('input', verifierNombreMin);
        nombreMinParts.addEventListener('input', verifierNombreMin);
    }

    /* =======================
       DATE DE FIN
    ======================= */
    function calculerDateFin() {
        if (!dateDebut.value || !duree.value) {
            dateFin.value = '';
            return;
        }

        const d = new Date(dateDebut.value);
        d.setMonth(d.getMonth() + parseInt(duree.value));

        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');

        dateFin.value = `${yyyy}-${mm}-${dd}`;
    }

    /* =======================
    COMPTEUR DE CARACTÈRES
    ======================= */
    if (description && charCount) {
        function updateCharCount() {
            const len = description.value.length;
            charCount.textContent = len;

            charCount.classList.toggle('text-danger', len < MIN_CHARS);
            charCount.classList.toggle('text-success', len >= MIN_CHARS);
        }

        description.addEventListener('input', updateCharCount);
        updateCharCount();
    }


    /* =======================
       EVENTS
    ======================= */
    if (montantTotal && nombreParts) {
    montantTotal.addEventListener('input', calculerPrixUnitaire);
    nombreParts.addEventListener('input', calculerPrixUnitaire);
    }

    if (dateDebut && duree) {
        dateDebut.addEventListener('change', calculerDateFin);
        duree.addEventListener('input', calculerDateFin);
    }


    /* =======================
       INIT
    ======================= */
    calculerPrixUnitaire();
    calculerDateFin();
    updateCharCount();
});
</script>


<style>
.steps-progress {
    display: flex;
    justify-content: space-between;
    max-width: 800px;
    margin: 0 auto;
}

.step {
    text-align: center;
    flex: 1;
    position: relative;
}

.step-number {
    display: inline-block;
    width: 40px;
    height: 40px;
    line-height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    font-weight: bold;
    margin-bottom: 5px;
    border: 3px solid #e9ecef;
}

.step.active .step-number {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.step-label {
    display: block;
    font-size: 14px;
    color: #6c757d;
}

.step.active .step-label {
    color: #007bff;
    font-weight: 500;
}

.section-header {
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
    margin-top: 30px;
}

.required::after {
    content: " *";
    color: #dc3545;
}

/* Style pour les champs invalides */
.is-invalid {
    border-color: #dc3545 !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.is-invalid:focus {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25) !important;
}

/* Style pour les champs valides (calculs) */
.is-valid {
    border-color: #198754 !important;
    background-color: #f8fff9;
}

/* Style pour la prévisualisation d'image */
#imagePreview {
    margin-top: 10px;
    text-align: center;
}

#previewImage {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Style pour le compteur de caractères */
#charCount {
    font-weight: bold;
    font-size: 0.9em;
}

/* Style pour les labels requis */
.required::after {
    content: " *";
    color: #dc3545;
}

/* Animation pour les champs */
.form-control {
    transition: all 0.3s ease;
}

.form-control:focus {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Style pour l'information sur le seuil */
.alert-info {
    border-left: 4px solid #0dcaf0;
}

.alert-info h6 {
    color: #055160;
}
</style>
{% endblock %}