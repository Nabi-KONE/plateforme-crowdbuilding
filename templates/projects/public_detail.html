{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ project.titre }} - CrowdBuilding{% endblock %}

{% block content %}
<style>
    /* DESIGN MODERNE ET COMPACT */
    .hero-section {
        position: relative;
        height: 350px;
        overflow: hidden;
        border-radius: 0 0 20px 20px;
    }
    
    .hero-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to bottom, 
            rgba(0,0,0,0.1) 0%, 
            rgba(0,0,0,0.4) 70%,
            rgba(0,0,0,0.7) 100%);
    }
    
    .hero-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 30px 0;
    }
    
    /* Layout principal align√© √† GAUCHE */
    .main-container {
        max-width: 100%;
        margin: 0;
        padding: 0 15px;
    }
    
    /* Contenu principal - align√© √† gauche */
    .main-content {
        width: 100%;
        margin-left: 0;
        margin-right: auto;
    }
    
    /* Stats compactes */
    .stats-compact {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin: 30px 0;
        width: 100%;
    }
    
    .stat-compact-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid #eaeaea;
        text-align: center;
    }
    
    .stat-compact-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4px;
    }
    
    .stat-compact-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Layout principal - align√© √† gauche */
    .main-layout {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 25px;
        margin-top: 30px;
        width: 100%;
    }
    
    .content-column {
        display: flex;
        flex-direction: column;
        gap: 25px;
        width: 100%;
    }
    
    .sidebar-column {
        position: sticky;
        top: 20px;
        height: fit-content;
    }
    
    /* Section financement compacte */
    .finance-section {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border: 1px solid #e8e8e8;
        width: 100%;
    }
    
    .progress-wrapper {
        margin: 20px 0;
    }
    
    .progress-bar-seuil {
        height: 12px;
        background: #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        width: 100%;
    }
    
    /* CORRECTION : Couleur de la barre de progression */
    .progress-fill-seuil {
        height: 100%;
        border-radius: 8px;
        transition: width 1s ease-in-out;
        width: {{ project.taux_financement }}% !important;
    }
    
    /* Logique de couleur pour la barre de progression */
    {% if project.taux_financement >= project.seuil_declenchement %}
    .progress-fill-seuil {
        background: linear-gradient(90deg, #10b981, #059669); /* Vert quand seuil atteint */
    }
    {% else %}
    .progress-fill-seuil {
        background: linear-gradient(90deg, #3b82f6, #2563eb); /* Bleu quand pas encore atteint */
    }
    {% endif %}
    
    /* Indicateur de seuil */
    .seuil-marker {
        position: absolute;
        top: -5px;
        width: 3px;
        height: 22px;
        background: #ef4444;
        z-index: 2;
    }
    
    .seuil-label {
        position: absolute;
        top: -30px;
        transform: translateX(-50%);
        font-size: 0.75rem;
        font-weight: 700;
        color: #ef4444;
        background: white;
        padding: 3px 8px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(239, 68, 68, 0.2);
        white-space: nowrap;
    }
    
    /* Cartes d'investissement r√©duites */
    .investment-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin: 20px 0;
        width: 100%;
    }
    
    .investment-card {
        background: #f8fafc;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        border: 2px solid #e2e8f0;
        width: 100%;
    }
    
    .investment-label {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .investment-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
    }
    
    /* Bouton d'investissement */
    .btn-invest-lg {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 16px;
        font-size: 1rem;
        font-weight: 700;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s ease;
        margin: 15px 0;
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
    }
    
    .btn-invest-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }
    
    /* Onglets modernes */
    .tabs-modern {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        width: 100%;
    }
    
    .tabs-header {
        display: flex;
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        padding: 0 15px;
        flex-wrap: wrap;
        width: 100%;
    }
    
    .tab-btn {
        padding: 15px 20px;
        background: none;
        border: none;
        font-size: 0.9rem;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        position: relative;
        white-space: nowrap;
    }
    
    .tab-btn.active {
        color: #4f46e5;
    }
    
    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
    }
    
    .tab-content {
        padding: 25px;
        width: 100%;
    }
    
    /* Section promoteur */
    .promoteur-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid #eaeaea;
        width: 100%;
    }
    
    .promoteur-avatar {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        margin: 0 auto 15px;
    }
    
    .promoteur-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 20px;
        width: 100%;
    }
    
    .promoteur-stat {
        text-align: center;
    }
    
    .promoteur-stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: #2d3748;
    }
    
    .promoteur-stat-label {
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* RESPONSIVE FIXES - AM√âLIOR√â */
    @media (max-width: 1200px) {
        .main-layout {
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }
        
        .main-container {
            padding: 0 20px;
        }
    }
    
    @media (max-width: 1024px) {
        .main-layout {
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .tabs-header {
            overflow-x: auto;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-btn {
            padding: 12px 15px;
            font-size: 0.85rem;
        }
    }
    
    @media (max-width: 900px) {
        .main-layout {
            grid-template-columns: 1fr;
            gap: 25px;
        }
        
        .sidebar-column {
            position: static;
            width: 100%;
            max-width: 500px;
        }
        
        .stats-compact {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .hero-section {
            height: 300px;
        }
    }
    
    @media (max-width: 768px) {
        .main-container {
            padding: 0 15px;
        }
        
        .hero-section {
            height: 250px;
        }
        
        .investment-cards {
            grid-template-columns: 1fr;
        }
        
        .tabs-header {
            padding: 0 10px;
        }
        
        .tab-btn {
            padding: 10px 12px;
            font-size: 0.8rem;
        }
        
        .tab-content {
            padding: 20px 15px;
        }
        
        .promoteur-stats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .finance-section {
            padding: 20px;
        }
        
        .stat-compact-card {
            padding: 12px 10px;
        }
        
        .stat-compact-value {
            font-size: 1.1rem;
        }
        
        .btn-invest-lg {
            padding: 14px 12px;
            font-size: 0.95rem;
        }
    }
    
    @media (max-width: 600px) {
        .stats-compact {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .tabs-header {
            justify-content: flex-start;
            padding: 0 5px;
        }
        
        .tab-btn {
            padding: 8px 10px;
            font-size: 0.75rem;
            min-width: auto;
        }
        
        .hero-section {
            height: 220px;
        }
        
        .hero-content {
            padding: 20px 0;
        }
        
        .hero-content h1 {
            font-size: 1.5rem !important;
        }
        
        .promoteur-stats {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .promoteur-stat-value {
            font-size: 1rem;
        }
        
        .promoteur-avatar {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 480px) {
        .main-container {
            padding: 0 10px;
        }
        
        .tabs-header {
            overflow-x: auto;
            padding: 0;
        }
        
        .tab-btn {
            padding: 8px 8px;
            font-size: 0.7rem;
            flex-shrink: 0;
        }
        
        .tab-btn i {
            margin-right: 2px;
        }
        
        .finance-section {
            padding: 15px;
        }
        
        .investment-card {
            padding: 12px 8px;
        }
        
        .investment-value {
            font-size: 1rem;
        }
        
        .investment-label {
            font-size: 0.7rem;
        }
        
        .hero-section {
            height: 200px;
        }
        
        .hero-content h1 {
            font-size: 1.3rem !important;
        }
        
        .stat-compact-card {
            padding: 10px 8px;
        }
        
        .stat-compact-value {
            font-size: 1rem;
        }
        
        .stat-compact-label {
            font-size: 0.65rem;
        }
        
        .promoteur-stats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .promoteur-stat-value {
            font-size: 0.9rem;
        }
        
        .promoteur-stat-label {
            font-size: 0.6rem;
        }
    }
    
    @media (max-width: 360px) {
        .tabs-header {
            padding: 0;
        }
        
        .tab-btn {
            padding: 6px 6px;
            font-size: 0.65rem;
        }
        
        .tab-content {
            padding: 15px 10px;
        }
        
        .main-container {
            padding: 0 8px;
        }
        
        .hero-content h1 {
            font-size: 1.2rem !important;
        }
        
        .finance-section {
            padding: 12px;
        }
        
        .btn-invest-lg {
            padding: 12px 10px;
            font-size: 0.85rem;
        }
    }
</style>

<!-- Hero Section -->
<div class="hero-section">
    {% if project.image_garde %}
    <img src="{{ project.image_garde.url }}" alt="{{ project.titre }}" class="hero-image">
    {% else %}
    <div class="hero-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
    {% endif %}
    
    <div class="hero-overlay"></div>
    
    <div class="hero-content">
        <div class="container">
            <div class="d-flex gap-2 mb-3">
                <span class="badge bg-success py-2 px-3">
                    {{ project.get_statut_display }}
                </span>
                <span class="badge bg-info py-2 px-3">
                    {{ project.ville }}, {{ project.region }}
                </span>
            </div>
            
            <h1 class="h2 fw-bold text-white mb-2">{{ project.titre }}</h1>
            <p class="text-white-80 mb-0">Promoteur : {{ project.promoteur.nom_complet }}</p>
        </div>
    </div>
</div>

<div class="main-container">
    <div class="main-content">
        <!-- Statistiques compactes -->
        <div class="stats-compact">
            <div class="stat-compact-card">
                <div class="stat-compact-value">{{ project.montant_total|intcomma }} FCFA</div>
                <div class="stat-compact-label">Co√ªt total</div>
            </div>
            
            <div class="stat-compact-card">
                <div class="stat-compact-value">{{ project.taux_financement|floatformat:0 }}%</div>
                <div class="stat-compact-label">Collect√©</div>
            </div>
            
            <div class="stat-compact-card">
                <div class="stat-compact-value">
                    {% if project.parts_vendues %}
                        {{ project.parts_vendues|intcomma }}
                    {% else %}
                        0
                    {% endif %}
                </div>
                <div class="stat-compact-label">Parts vendues</div>
            </div>
            
            <div class="stat-compact-card">
                <div class="stat-compact-value">
                    {% if investisseurs_count %}
                        {{ investisseurs_count }}
                    {% else %}
                        0
                    {% endif %}
                </div>
                <div class="stat-compact-label">Investisseurs</div>
            </div>
        </div>

        <!-- Layout principal -->
        <div class="main-layout">
            <!-- Colonne de contenu -->
            <div class="content-column">
                <!-- Section financement -->
                <div class="finance-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h5 fw-bold mb-0">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            Progression du financement
                        </h3>
                        <div class="text-end">
                            <div class="h4 fw-bold {% if project.taux_financement >= project.seuil_declenchement %}text-success{% else %}text-primary{% endif %}">
                                {{ project.taux_financement|floatformat:1 }}%
                            </div>
                            <div class="text-muted small">{{ project.montant_collecte|intcomma }} FCFA</div>
                        </div>
                    </div>
                    
                    <!-- Barre de progression avec seuil - CORRIG√âE -->
                    <div class="progress-wrapper">
                        <div class="progress-bar-seuil">
                            <div class="progress-fill-seuil"></div>
                            
                            <!-- Indicateur de seuil -->
                            {% if project.seuil_declenchement %}
                            <div class="seuil-marker" style="left: {{ project.seuil_declenchement }}%">
                                <div class="seuil-label">Seuil {{ project.seuil_declenchement }}%</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-2 small">
                            <span class="text-muted">0%</span>
                            <span class="text-muted">100%</span>
                        </div>
                        
                        <!-- √âtat du seuil -->
                        <div class="text-center mt-3">
                            {% if project.taux_financement >= project.seuil_declenchement %}
                            <span class="badge bg-success py-2 px-3">
                                <i class="fas fa-check-circle me-2"></i>
                                Seuil atteint - Le projet peut d√©marrer !
                            </span>
                            {% else %}
                            <span class="badge bg-warning py-2 px-3">
                                <i class="fas fa-clock me-2"></i>
                                Seuil : {{ project.seuil_declenchement }}% requis
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Structure financi√®re -->
                    <div class="investment-cards">
                        <div class="investment-card">
                            <div class="investment-label">Prix unitaire</div>
                            <div class="investment-value">
                                {% with prix=project.prix_unitaire|default:project.valeur_part|default:0 %}
                                    {{ prix|floatformat:0|intcomma }} FCFA
                                {% endwith %}
                            </div>
                        </div>
                        
                        <div class="investment-card">
                            <div class="investment-label">Total parts</div>
                            <div class="investment-value">{{ project.nombre_total_parts|default:0|intcomma }}</div>
                        </div>
                        
                        <div class="investment-card">
                            <div class="investment-label">Parts vendues</div>
                            <div class="investment-value">
                                {% if project.parts_vendues %}
                                    {{ project.parts_vendues|intcomma }}
                                {% else %}
                                    0
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="investment-card">
                            <div class="investment-label">Parts restantes</div>
                            <div class="investment-value">
                                {% if project.parts_restantes %}
                                    {{ project.parts_restantes|intcomma }}
                                {% else %}
                                    {{ project.nombre_total_parts|default:0|intcomma }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations temporelles -->
                    <div class="row mt-4 g-3">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-day text-primary me-2"></i>
                                <div>
                                    <div class="small text-muted">D√©but pr√©vu</div>
                                    <div class="fw-bold">{{ project.date_debut|date:"d/m/Y" }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <div>
                                    <div class="small text-muted">Dur√©e collecte</div>
                                    <div class="fw-bold">{{ project.duree_campagne }} mois</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-primary me-2"></i>
                                <div>
                                    <div class="small text-muted">Dur√©e r√©alisation</div>
                                    <div class="fw-bold">{{ project.duree }} mois</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglets -->
                <div class="tabs-modern">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="description">
                            <i class="fas fa-align-left me-1"></i>Description
                        </button>
                        <button class="tab-btn" data-tab="documents">
                            <i class="fas fa-folder me-1"></i>Documents
                        </button>
                        <button class="tab-btn" data-tab="etapes">
                            <i class="fas fa-list-ol me-1"></i>√âtapes
                        </button>
                        <button class="tab-btn" data-tab="comptes-rendus">
                            <i class="fas fa-file-alt me-1"></i>Comptes rendus
                        </button>
                        <button class="tab-btn" data-tab="promoteur">
                            <i class="fas fa-user-tie me-1"></i>Promoteur
                        </button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Description -->
                        <div class="tab-pane active" id="description-tab">
                            <h4 class="h5 fw-bold mb-3">Description du projet</h4>
                            <div class="prose">
                                {{ project.description|linebreaks }}
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-2">Caract√©ristiques</h6>
                                    <ul class="list-unstyled small">
                                        <li class="mb-2">
                                            <i class="fas fa-home text-primary me-2"></i>
                                            <strong>Cat√©gorie :</strong> {{ project.get_categorie_display }}
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                            <strong>Localisation :</strong> {{ project.localisation }}
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-calendar-day text-primary me-2"></i>
                                            <strong>D√©but pr√©vu :</strong> {{ project.date_debut|date:"d/m/Y" }}
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold mb-2">Financement</h6>
                                    <ul class="list-unstyled small">
                                        <li class="mb-2">
                                            <i class="fas fa-money-bill-wave text-primary me-2"></i>
                                            <strong>Co√ªt total :</strong> {{ project.montant_total|intcomma }} FCFA
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-target text-primary me-2"></i>
                                            <strong>Seuil :</strong> {{ project.seuil_declenchement }}%
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-calendar-alt text-primary me-2"></i>
                                            <strong>Collecte :</strong> {{ project.duree_campagne }} mois
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Documents -->
                        <div class="tab-pane" id="documents-tab" style="display: none;">
                            <h4 class="h5 fw-bold mb-3">Documents</h4>
                            
                            {% if not user.is_authenticated %}
                            <div class="alert alert-info py-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-lock"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-2">Connexion requise</h6>
                                        <p class="small mb-2">Pour acc√©der aux documents :</p>
                                        <ul class="small mb-3">
                                            <li>Connectez-vous √† votre compte</li>
                                            <li>Investissez dans ce projet</li>
                                        </ul>
                                        <a href="{% url 'accounts:login' %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-sign-in-alt me-1"></i>Se connecter
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% elif user.is_authenticated and est_investisseur %}
                            <!-- Investisseur authentifi√© -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="border rounded p-3 text-center">
                                        <div class="mb-2">
                                            <i class="fas fa-landmark fa-2x text-primary"></i>
                                        </div>
                                        <h6 class="fw-bold mb-2">Document foncier</h6>
                                        <p class="small text-muted mb-2">Titre de propri√©t√©</p>
                                        <span class="badge bg-success">Consultable</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="border rounded p-3 text-center">
                                        <div class="mb-2">
                                            <i class="fas fa-tools fa-2x text-primary"></i>
                                        </div>
                                        <h6 class="fw-bold mb-2">Permis de construire</h6>
                                        <p class="small text-muted mb-2">Document technique</p>
                                        <span class="badge bg-success">Consultable</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div class="border rounded p-3 text-center">
                                        <div class="mb-2">
                                            <i class="fas fa-chart-line fa-2x text-primary"></i>
                                        </div>
                                        <h6 class="fw-bold mb-2">Budget global</h6>
                                        <p class="small text-muted mb-2">Document financier</p>
                                        <span class="badge bg-success">Consultable</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-light border small mt-3">
                                <div class="d-flex">
                                    <div class="me-2">
                                        <i class="fas fa-shield-alt text-primary"></i>
                                    </div>
                                    <div>
                                        Documents s√©curis√©s. Consultation uniquement.
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-primary py-3">
                                <div class="d-flex">
                                    <div class="me-3">
                                        <i class="fas fa-info-circle"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-2">Comment acc√©der ?</h6>
                                        <ol class="small mb-3">
                                            <li>Cr√©ez un compte investisseur</li>
                                            <li>Investissez dans ce projet</li>
                                        </ol>
                                        <a href="{% url 'accounts:register' %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-user-plus me-1"></i>Cr√©er un compte
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- √âtapes -->
                        <div class="tab-pane" id="etapes-tab" style="display: none;">
                            <h4 class="h5 fw-bold mb-3">√âtapes de r√©alisation</h4>
                            {% if project.etapes.all %}
                            <div class="etapes-timeline">
                                {% for etape in project.etapes.all %}
                                <div class="d-flex align-items-start mb-3">
                                    <div class="me-3">
                                        <div class="rounded-circle {% if etape.terminee %}bg-success{% else %}bg-primary{% endif %} text-white d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px; font-size: 1rem;">
                                            {{ forloop.counter }}
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 border rounded p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="fw-bold mb-0 small">{{ etape.titre }}</h6>
                                            <span class="badge {% if etape.terminee %}bg-success{% else %}bg-warning{% endif %} py-1 px-2 small">
                                                {% if etape.terminee %}Termin√©{% else %}√Ä venir{% endif %}
                                            </span>
                                        </div>
                                        <p class="text-muted small mb-2">{{ etape.description|truncatechars:100 }}</p>
                                        {% if etape.duree_estimee %}
                                        <div class="d-flex align-items-center small">
                                            <i class="fas fa-clock text-muted me-1"></i>
                                            <span class="text-muted">{{ etape.duree_estimee }} mois</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-calendar-alt fa-2x text-muted mb-3"></i>
                                <p class="text-muted small">√âch√©ancier √† venir</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Comptes rendus -->
                        <div class="tab-pane" id="comptes-rendus-tab" style="display: none;">
                            <h4 class="h5 fw-bold mb-3">Comptes rendus</h4>
                            {% if comptes_rendus %}
                            <div class="comptes-rendus-list">
                                {% for cr in comptes_rendus %}
                                <div class="border rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="fw-bold mb-0 small">{{ cr.titre }}</h6>
                                        <span class="badge bg-primary py-1 px-2 small">{{ cr.avancement }}%</span>
                                    </div>
                                    <p class="text-muted small mb-2">{{ cr.contenu|linebreaks|truncatechars:150 }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-alt me-1"></i>{{ cr.date_publication|date:"d/m/Y" }}
                                        </small>
                                        <button class="btn btn-sm btn-outline-primary py-1 px-2 small" onclick="showCompteRenduDetail({{ cr.id }})">
                                            <i class="fas fa-eye me-1"></i> D√©tails
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-file-alt fa-2x text-muted mb-3"></i>
                                <p class="text-muted small">Aucun compte rendu disponible</p>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Onglet Promoteur -->
                        <div class="tab-pane" id="promoteur-tab" style="display: none;">
                            <h4 class="h5 fw-bold mb-3">√Ä propos du promoteur</h4>
                            
                            <div class="promoteur-card">
                                <div class="text-center mb-4">
                                    <div class="promoteur-avatar">
                                        {{ project.promoteur.prenom|first|upper }}{{ project.promoteur.nom|first|upper }}
                                    </div>
                                    <h5 class="fw-bold mb-2">{{ project.promoteur.nom_complet }}</h5>
                                    <p class="text-muted small">
                                        <i class="fas fa-briefcase me-1"></i>
                                        {{ project.promoteur.profession|default:"Promoteur immobilier" }}
                                    </p>
                                </div>
                                
                                {% if project.promoteur.experience %}
                                <div class="mb-4">
                                    <h6 class="fw-bold mb-2 small">Exp√©rience</h6>
                                    <div class="bg-light p-3 rounded small">
                                        {{ project.promoteur.experience|linebreaks|truncatechars:300 }}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Statistiques du promoteur -->
                                <div class="promoteur-stats">
                                    <div class="promoteur-stat">
                                        <div class="promoteur-stat-value">{{ project.promoteur.projets.count }}</div>
                                        <div class="promoteur-stat-label">Projets</div>
                                    </div>
                                    <div class="promoteur-stat">
                                        <div class="promoteur-stat-value">100%</div>
                                        <div class="promoteur-stat-label">Taux r√©ussite</div>
                                    </div>
                                    <div class="promoteur-stat">
                                        <div class="promoteur-stat-value">
                                            {% if annees_experience %}
                                                {{ annees_experience }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </div>
                                        <div class="promoteur-stat-label">Ann√©es exp.</div>
                                    </div>
                                </div>
                                
                                <!-- Contact info -->
                                {% if project.promoteur.telephone or project.promoteur.email %}
                                <div class="mt-4 pt-3 border-top">
                                    <h6 class="fw-bold mb-3 small">Contact</h6>
                                    <div class="row g-2">
                                        {% if project.promoteur.telephone %}
                                        <div class="col-6">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-phone text-primary me-2 small"></i>
                                                <span class="small">{{ project.promoteur.telephone }}</span>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if project.promoteur.email %}
                                        <div class="col-6">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-envelope text-primary me-2 small"></i>
                                                <span class="small">{{ project.promoteur.email }}</span>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar d'investissement -->
            <div class="sidebar-column">
                <div class="finance-section">
                    <h3 class="h5 fw-bold text-center mb-3">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Investir
                    </h3>
                    
                    <!-- Statistique investisseurs -->
                    <div class="text-center mb-4">
                        <div class="h3 fw-bold text-info mb-2">
                            {% if investisseurs_count %}
                                {{ investisseurs_count }}
                            {% else %}
                                0
                            {% endif %}
                        </div>
                        <div class="text-muted small">Investisseurs engag√©s</div>
                    </div>
                    
                    <!-- Informations temporelles -->
                    <div class="investment-cards mb-4">
                        <div class="investment-card">
                            <div class="investment-label">D√©but pr√©vu</div>
                            <div class="investment-value">{{ project.date_debut|date:"d/m/Y" }}</div>
                        </div>
                        
                        <div class="investment-card">
                            <div class="investment-label">Dur√©e r√©alisation</div>
                            <div class="investment-value">{{ project.duree }} mois</div>
                        </div>
                    </div>
                    
                    <!-- Bouton d'investissement -->
                    {% if project.statut == 'EN_CAMPAGNE' %}
                        {% if user.is_authenticated and est_investisseur %}
                        <a href="{% url 'investments:investir' project.id %}" class="btn-invest-lg">
                            <i class="fas fa-chart-line"></i>
                            Investir maintenant
                        </a>
                        {% else %}
                        <button class="btn-invest-lg" onclick="showLoginRequired()">
                            <i class="fas fa-chart-line"></i>
                            Investir maintenant
                        </button>
                        {% endif %}
                    {% elif project.statut == 'EN_ATTENTE_VALIDATION' %}
                        <button class="btn-invest-lg bg-secondary" disabled>
                            <i class="fas fa-hourglass-half"></i>
                            En validation
                        </button>
                    {% elif project.statut == 'EN_COURS_EXECUTION' %}
                        <button class="btn-invest-lg bg-secondary" disabled>
                            <i class="fas fa-hammer"></i>
                            En cours
                        </button>
                    {% elif project.statut == 'TERMINE' %}
                        <button class="btn-invest-lg bg-secondary" disabled>
                            <i class="fas fa-flag-checkered"></i>
                            Termin√©
                        </button>
                    {% else %}
                        <button class="btn-invest-lg bg-secondary" disabled>
                            <i class="fas fa-lock"></i>
                            Termin√©
                        </button>
                    {% endif %}
                    
                    <!-- Avantages r√©duits -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3 small">Pourquoi investir ?</h6>
                        <div class="row g-2">
                            <div class="col-3 text-center">
                                <div class="p-1">
                                    <i class="fas fa-shield-alt text-success mb-1"></i>
                                    <div class="small">S√©curis√©</div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="p-1">
                                    <i class="fas fa-file-contract text-primary mb-1"></i>
                                    <div class="small">L√©gal</div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="p-1">
                                    <i class="fas fa-chart-bar text-warning mb-1"></i>
                                    <div class="small">Suivi</div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="p-1">
                                    <i class="fas fa-headset text-info mb-1"></i>
                                    <div class="small">Support</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message de r√©assurance -->
                    <div class="alert alert-light border-0 small mt-4 p-3">
                        <div class="d-flex align-items-start">
                            <div class="me-2">
                                <i class="fas fa-check-circle text-success"></i>
                            </div>
                            <div>
                                <strong>Investissement s√©curis√©</strong><br>
                                Capital prot√©g√© avec suivi r√©gulier.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bouton Retour -->
                <div class="text-center mt-3">
                    <a href="{% url 'projects:list' %}" class="btn btn-outline-primary w-100 py-2">
                        <i class="fas fa-arrow-left me-2"></i>Retour aux projets
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour d√©tails compte rendu -->
<div class="modal fade" id="compteRenduModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <small class="text-muted" id="crDate"></small>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="badge bg-primary" id="crAvancement"></span>
                    </div>
                </div>
                <div id="crContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
// Gestion des onglets
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // D√©sactiver tous les onglets
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
            document.getElementById(b.getAttribute('data-tab') + '-tab').style.display = 'none';
        });
        
        // Activer l'onglet cliqu√©
        this.classList.add('active');
        document.getElementById(tabId + '-tab').style.display = 'block';
    });
});

// Fonction de connexion requise
function showLoginRequired() {
    if (!{% if user.is_authenticated %}true{% else %}false{% endif %}) {
        alert('üîí Connexion requise\n\nPour investir, veuillez vous connecter ou cr√©er un compte.');
    } else if (!{% if est_investisseur %}true{% else %}false{% endif %}) {
        alert('üìã Profil investisseur requis\n\nCompl√©tez votre profil investisseur dans vos param√®tres.');
    }
}

// Fonction pour afficher les d√©tails d'un compte rendu
function showCompteRenduDetail(crId) {
    fetch(`/api/comptes-rendus/${crId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('crTitle').textContent = data.titre;
            document.getElementById('crDate').innerHTML = `<i class="fas fa-calendar-alt me-2"></i>${data.date_publication}`;
            document.getElementById('crAvancement').textContent = `Avancement: ${data.avancement}%`;
            document.getElementById('crContent').innerHTML = `<div class="prose">${data.contenu}</div>`;
            
            const modal = new bootstrap.Modal(document.getElementById('compteRenduModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Impossible de charger les d√©tails');
        });
}

// Animation de la barre de progression
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-fill-seuil');
    if (progressBar) {
        const finalWidth = progressBar.style.width;
        progressBar.style.width = '0%';
        
        setTimeout(() => {
            progressBar.style.width = finalWidth;
        }, 500);
    }
});
</script>
{% endblock %}