{% extends 'base.html' %}
{% load static %}

{% block title %}Valider les Documents - CrowdBuilding{% endblock %}

{% block extra_css %}
<style>
.document-card {
    border-left: 4px solid #ffc107;
    transition: all 0.3s ease;
}

.document-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.user-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
}

.badge-role {
    font-size: 0.8em;
}

.action-buttons .btn {
    min-width: 100px;
}

.modal-refus textarea {
    resize: vertical;
    min-height: 120px;
}

.document-preview {
    max-height: 400px;
    overflow-y: auto;
}

.avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 1em;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- En-tête -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 fw-bold mb-1">
                        <i class="fas fa-file-check me-2"></i>Validation des Documents
                    </h1>
                    <p class="text-muted mb-0">
                        Documents en attente de validation - Administration
                    </p>
                </div>
                <div class="text-end">
                    <span class="badge bg-warning fs-6">{{ documents_attente.count }} document(s) en attente</span>
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            {% if documents_attente %}
                <div class="row">
                    {% for document in documents_attente %}
                    <div class="col-lg-6 mb-4">
                        <div class="card document-card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">
                                    <i class="fas fa-file me-2"></i>{{ document.nom }}
                                </h6>
                                <span class="badge bg-warning">En attente</span>
                            </div>
                            
                            <div class="card-body">
                                <!-- Informations utilisateur -->
                                <div class="user-info p-3 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar me-3">
                                            {{ document.get_proprietaire.prenom|first }}{{ document.get_proprietaire.nom|first }}
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold">
                                                {{ document.get_proprietaire.prenom }} {{ document.get_proprietaire.nom }}
                                            </h6>
                                            <small class="opacity-75">
                                                <i class="fas fa-envelope me-1"></i>
                                                {{ document.get_proprietaire.email }}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge badge-role bg-dark">
                                                {{ document.get_proprietaire.get_role_actif_display }}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations document -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Type</small>
                                        <div class="fw-bold">
                                            <i class="fas fa-tag me-2"></i>
                                            {{ document.get_type_display }}
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Taille</small>
                                        <div class="fw-bold">
                                            <i class="fas fa-weight me-2"></i>
                                            {{ document.taille_mb }} MB
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-12">
                                        <small class="text-muted">Date d'upload</small>
                                        <div class="fw-bold">
                                            <i class="fas fa-clock me-2"></i>
                                            {{ document.date_telechargement|date:"d/m/Y à H:i" }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Aperçu du document -->
                                <div class="mb-3">
                                    <small class="text-muted">Aperçu</small>
                                    <div class="document-preview border rounded p-3 bg-light">
                                        {% if document.est_pdf %}
                                            <p class="mb-2">
                                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                                Document PDF - 
                                                <a href="{{ document.fichier.url }}" target="_blank" class="text-decoration-none">
                                                    Voir le document
                                                    <i class="fas fa-external-link-alt ms-1"></i>
                                                </a>
                                            </p>
                                        {% elif document.est_image %}
                                            <p class="mb-2">
                                                <i class="fas fa-file-image text-success me-2"></i>
                                                Image - 
                                                <a href="{{ document.fichier.url }}" target="_blank" class="text-decoration-none">
                                                    Voir l'image
                                                    <i class="fas fa-external-link-alt ms-1"></i>
                                                </a>
                                            </p>
                                            <!-- Aperçu de l'image -->
                                            <div class="text-center mt-2">
                                                <img src="{{ document.fichier.url }}" alt="Aperçu" style="max-height: 200px; max-width: 100%;" class="rounded border">
                                            </div>
                                        {% else %}
                                            <p class="mb-2">
                                                <i class="fas fa-file text-primary me-2"></i>
                                                Document - 
                                                <a href="{{ document.fichier.url }}" target="_blank" class="text-decoration-none">
                                                    Télécharger
                                                    <i class="fas fa-download ms-1"></i>
                                                </a>
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="action-buttons d-flex gap-2">
                                    <button class="btn btn-success flex-fill" 
                                            onclick="validerDocument({{ document.id }})">
                                        <i class="fas fa-check me-2"></i>Valider
                                    </button>
                                    <button class="btn btn-danger flex-fill" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalRefus{{ document.id }}">
                                        <i class="fas fa-times me-2"></i>Refuser
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal de refus -->
                    <div class="modal fade" id="modalRefus{{ document.id }}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Refuser le document
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Vous êtes sur le point de refuser le document <strong>"{{ document.nom }}"</strong> de <strong>{{ document.get_proprietaire.prenom }} {{ document.get_proprietaire.nom }}</strong>.</p>
                                    <p>Veuillez indiquer le motif du refus :</p>
                                    <div class="form-group">
                                        <textarea class="form-control modal-refus" id="motifRefus{{ document.id }}" 
                                                  placeholder="Ex: Document illisible, informations manquantes, format non conforme..."></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                    <button type="button" class="btn btn-danger" 
                                            onclick="refuserDocument({{ document.id }})">
                                        Confirmer le refus
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                    <h3>Aucun document en attente</h3>
                    <p class="text-muted">Tous les documents ont été traités.</p>
                    <a href="{% url 'core:dashboard' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Retour au tableau de bord
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function validerDocument(documentId) {
    if (confirm('Êtes-vous sûr de vouloir valider ce document ?')) {
        // Envoyer la requête AJAX pour valider
       fetch(`/admin-perso/documents/${documentId}/valider/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=valider`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Erreur lors de la validation du document.');
        });
    }
}

function refuserDocument(documentId) {
    const motif = document.getElementById(`motifRefus${documentId}`).value.trim();
    
    if (!motif) {
        showAlert('warning', 'Veuillez saisir un motif de refus.');
        return;
    }
    
    // Envoyer la requête AJAX pour refuser
    fetch(`/documents/admin/validate/${documentId}/action/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=refuser&motif=${encodeURIComponent(motif)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Fermer la modal
            const modal = bootstrap.Modal.getInstance(document.getElementById(`modalRefus${documentId}`));
            modal.hide();
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'Erreur lors du refus du document.');
    });
}

function showAlert(type, message) {
    // Créer une alerte Bootstrap
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${getAlertIcon(type)} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insérer l'alerte en haut de la page
    const container = document.querySelector('.container-fluid .row .col-12');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-supprimer après 5 secondes
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

function getAlertIcon(type) {
    const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Auto-close modals on success
document.addEventListener('hidden.bs.modal', function (event) {
    const modal = event.target;
    const textarea = modal.querySelector('textarea');
    if (textarea) {
        textarea.value = '';
    }
});

// Auto-focus sur les textareas des modals
document.addEventListener('shown.bs.modal', function (event) {
    const modal = event.target;
    const textarea = modal.querySelector('textarea');
    if (textarea) {
        textarea.focus();
    }
});
</script>
{% endblock %}